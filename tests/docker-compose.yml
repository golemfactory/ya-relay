version: "3.8"

services:
  relay_server:
    build:
      context: ../
      dockerfile: test_env/Dockerfile.server
    cap_add:
    - NET_ADMIN
    environment:
      - LATENCY=${SERVER_LATENCY}
      - RUST_LOG=${RUST_LOG}
    ports:
      - "7464:7464/tcp"
      - "7464:7464/udp"
      - "7465:7465/tcp"
      - "7465:7465/udp"
    networks:
      - public_network
      - shared_a_network
      - shared_b_network
    hostname: relay_server

  public_client:
    build:
      context: ../
      dockerfile: test_env/Dockerfile.client
    cap_add:
    - NET_ADMIN
    environment:
      ## Empty BIND_IP makes Dockerfile to not export P2P_BIND_ADDR
      # - BIND_IP=
      - BIND_IP=${PUBLIC_BIND_IP}
      ## Without BIND_IP_PATTERN and BIND_IP it will bind to 0.0.0.0
      # - BIND_IP_PATTERN=^172\.22\.0\.
      # - BIND_IP_PATTERN=^172\.25\.0\.
      - BIND_IP_PATTERN=${PUBLIC_BIND_IP_PATTERN}
      - BIND_PROTO=${PUBLIC_BIND_PROTO}
      - LATENCY=${CLIENT_LATENCY}
      - RUST_LOG=${RUST_LOG}
    ports:
      - "51000-51999:8081"
      - "52000-52999:9081/tcp"
      - "52000-52999:9081/udp"
    networks:
      - public_network
      - shared_a_network
      - shared_b_network
    depends_on:
      - relay_server

  alice_client:
    build:
      context: ../
      dockerfile: test_env/Dockerfile.client
    cap_add:
    - NET_ADMIN
    environment:
      ## Empty BIND_IP makes Dockerfile to not export P2P_BIND_ADDR
      # - BIND_IP=
      - BIND_IP=${ALICE_BIND_IP}
      ## P2P_BIND_ADDR set to address from private net breakes session init
      # - BIND_IP_PATTERN=^172\.23\.0\.
      # - BIND_IP_PATTERN=^172\.25\.0\.
      - BIND_IP_PATTERN=${ALICE_BIND_IP_PATTERN}
      - BIND_PROTO=${ALICE_BIND_PROTO}
      - LATENCY=${CLIENT_LATENCY}
      - RUST_LOG=${RUST_LOG}
    ports:
      - "53000-53999:8081"
      - "54000-54999:9081/tcp"
      - "54000-54999:9081/udp"
    networks:
      - alice_network
      - public_network
      - shared_a_network
    depends_on:
      - relay_server

  bob_client:
    build:
      context: ../
      dockerfile: test_env/Dockerfile.client
    cap_add:
    - NET_ADMIN
    environment:
      ## Empty BIND_IP makes Dockerfile to not export P2P_BIND_ADDR
      # - BIND_IP=
      - BIND_IP=${BOB_BIND_IP}
      ## P2P_BIND_ADDR set to address from private net breakes session init
      # - BIND_IP_PATTERN=^172\.24\.0\.
      # - BIND_IP_PATTERN=^172\.26\.0\.
      - BIND_IP_PATTERN=${BOB_BIND_IP_PATTERN}
      - BIND_PROTO=${BOB_BIND_PROTO}
      - LATENCY=${CLIENT_LATENCY}
      - RUST_LOG=${RUST_LOG}
    ports:
      - "55000-55999:8081"
      - "56000-56999:9081/tcp"
      - "56000-56999:9081/udp"
    networks:
      - bob_network
      - public_network
      - shared_b_network
    depends_on:
      - relay_server

# IMPORTANT: network name affects order (and which network default interface is using)
networks:
  public_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
  alice_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/16
  bob_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.24.0.0/16
  # name starting with "shared_" is meant to place it after "public_", "alice_", and "bob_"
  shared_a_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
  shared_b_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16
